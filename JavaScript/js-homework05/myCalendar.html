<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap</title>
    <!-- 載入reset CSS -->
    <link rel="stylesheet" href="/utility-css/reset.css">
    <!-- 載入Bootstrap 5.0 CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- CSS撰寫區 -->
    <style>

    </style>
</head>

<body>
    <h1 class="year-month"></h1>
    <button type="button" class="btn btn-primary" onclick="previewMonth()">preview month</button>
    <button type="button" class="btn btn-primary" onclick="nowMonth()">now</button>
    <button type="button" class="btn btn-primary" onclick="nextMonth()">next month</button>


    <table class="table">
        <thead>
            <tr>
                <th>日</th>
                <th>一</th>
                <th>二</th>
                <th>三</th>
                <th>四</th>
                <th>五</th>
                <th>六</th>
            </tr>
        </thead>
        <tbody>
            <!-- 動態渲染日期 -->

        </tbody>
    </table>

    <!-- 新增行程 Modal -->
    <!-- 
        1. 複製Modal
        2. class多加上fade
        3. modal-title 改掉
        4. modal-body 加上輸入框
        5. modal-footer  調整成一個 新增按鈕
        
        測試: 
        bootstrap.Modal.getOrCreateInstance(document.querySelector("#add-modal")).show()
        
        js 設定出現: show()
        js 設定隱藏: hide()
    -->
    <div class="modal fade" tabindex="-1" id="add-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!-- 修改title -->
                    <h5 class="modal-title">新增行程</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 新增兩個輸入框 -->
                    <input type="text" id="add-date">
                    <input type="text" id="add-value">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="addTodoItem()">新增</button>
                </div>
            </div>
        </div>
    </div>


    <!-- 編輯行程 Modal -->
    <!-- 
        1. 複製Modal
        2. class多加上fade
        3. modal-title 改掉
        4. modal-body 加上輸入框
        5. modal-footer  調整成 修改按鈕 & 刪除按鈕

        測試: 
        bootstrap.Modal.getOrCreateInstance(document.querySelector("#edit-modal")).show()

        js 設定出現: show()
        js 設定隱藏: hide()
    -->
    <div class="modal fade" tabindex="-1" id="edit-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!-- 修改title -->
                    <h5 class="modal-title">編輯行程</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 新增兩個輸入框 -->
                    <input type="text" id="edit-date">
                    <input type="text" id="edit-value">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="editTodoItem()">修改</button>
                    <button type="button" class="btn btn-danger" onclick="delTodoItem()">刪除</button>
                </div>
            </div>
        </div>
    </div>


    <!-- script 撰寫區 -->
    <script>
        // 宣告===================
        // step1. 先取得系統年月及第一天為星期幾
        const today = new Date();
        let year = today.getFullYear();
        let month = today.getMonth();
        let firstDay;
        let lastDay;
        let weekly;

        // new Date 取得的 month 是由 0 開始
        queryfirstDay(year, month);
        querylastDay(year, month);
        querylastDate(year, month);


        // 當月的日期
        let showDate;
        // 上個月的日期
        let dayofpremonth;
        let preD;
        // 下個月的日期
        let nextD;
        // 行事曆另外存的日期
        let day ;

        // DOM===================
        const title = document.querySelector(".year-month");
        const tbody = document.querySelector("tbody");

        // 觸發工作項目時
        const addModal = document.querySelector("#add-modal");
        const editModal = document.querySelector("#edit-modal");

        // 新增視窗modal
        const addDateInput = document.querySelector("#add-date")
        const addValueInput = document.querySelector("#add-value")

        // 編輯視窗modal
        const editDateInput = document.querySelector("#edit-date")
        const editValueInput = document.querySelector("#edit-value")



        // function===================

        // 月份第一天是星期幾
        function queryfirstDay(y, m) {
            firstDay = new Date(y, m, 1).getDay();

        }

        // 月份最後一天是星期幾
        function querylastDay(y, m) {
            lastDay = new Date(y, m + 1, 0).getDay();

        }
        // 月份最後一天是幾號
        function querylastDate(y, m) {
            lastDay = new Date(y, m + 1, 0).getDate();

        }



        // 取得當月的前一個月最後一天日期
        function fillPrevievDate() {

            let preMonth = month - 1;
            let preYear = year;

            if (preMonth < 0) {
                preYear--;
                preMonth = 11;
            }
            let preLastDate = new Date(preYear, preMonth + 1, 0).getDate();;
            return preLastDate;


        }

        // 上個月
        function previewMonth() {
            month--;
            if (month < 0) {
                year--;
                month = 11;
            }
            queryfirstDay(year, month);
            querylastDate(year, month);

            randerData();
        }

        // 當月
        function nowMonth() {
            year = today.getFullYear();
            month = today.getMonth();
            queryfirstDay(year, month);
            querylastDate(year, month);

            randerData();
        }
        // 下個月

        function nextMonth() {
            month++;
            if (month > 11) {
                year++;
                month = 0;
            }

            queryfirstDay(year, month);
            querylastDate(year, month);
            randerData();

        }
        // window onload===================
        window.onload = function () {
            // 取得年月資料

            randerData();

        }

        // 渲染資料
        function randerData() {

            // 渲染標題
            title.innerText = `${year}年${month + 1}月`;
            // 渲染日期
            renderCalendar();

        }

        // 移除新增的節點內容
        function removeRander(node) {

            while (node.firstChild) {
                node.removeChild(node.firstChild);
            }

        }

        // 初始化 tbody
        function initTbody() {
            // 清除日曆節點
            removeRander(tbody);
            // 日期變數初始化
            dayofpremonth = fillPrevievDate();
            preD = dayofpremonth;

            if (firstDay != 0) {
                preD = (dayofpremonth - firstDay) + 1;
            }

            showDate = 1;
            nextD = 1;
        }


        // 渲染行事曆日期
        function renderCalendar() {

            initTbody();

            // 當月有幾週?
            weekly = Math.ceil((lastDay + firstDay) / 7);

            for (let row = 0; row < weekly; row++) {

                const tr = document.createElement("tr");
                for (let col = 0; col < 7; col++) {

                    // 如果是第一週且 上個月的日期 在 上個月最後一天內
                    if (row == 0 && col < firstDay) {


                        // 要印上個月的日期

                        const td = document.createElement("td");
                        td.innerText = preD;
                        let day = td.innerText;
                        td.onclick = function () {
                            addDateInput.value = `${year}-${month + 1}-${day}`;
                            // 呼叫 bootstrap Modal
                            bootstrap.Modal.getOrCreateInstance(addModal).show();
                        }
                        tr.appendChild(td);
                        preD++;


                    } else {
                        if (showDate <= lastDay) {
                            
                            // 本月份日期
                            const td = document.createElement("td");
                            td.innerText = showDate;
                            let day = td.innerText;

                            // 渲染 localstorage 資料
                            // step1. 查看今天是否有行程
                            if (localStorage.getItem(`${year}-${(month + 1)}-${day}`) != null) {
                                
                                // 今天有行程
                                let ul = document.createElement("ul");
                              
                                let todoList = JSON.parse(localStorage.getItem(`${year}-${(month + 1)}-${day}`));


                                todoList.forEach((item,index) => {
                                    let li = document.createElement("li");
                                    li.innerText = item.title;

                                    li.onclick = function (e) {
                                        // 去localstorage抓當天的資料
                                        editDateInput.value = `${year}-${(month + 1)}-${day}`;
                                        editValueInput.value = e.target.innerText;
                                        editValueInput.setAttribute("data-num",index);

                                        bootstrap.Modal.getOrCreateInstance(editModal).show();
                                        e.stopPropagation();
                                    }
                                    ul.appendChild(li);

                                });

                                td.appendChild(ul);
                            }


                            td.onclick = function () {
                                addDateInput.value = `${year}-${month + 1}-${day}`;
                                // 呼叫 bootstrap Modal
                                bootstrap.Modal.getOrCreateInstance(addModal).show();
                            }
                            tr.appendChild(td);
                            showDate++;

                        } else {
                            // 下個月日期
                            const td = document.createElement("td");
                            td.innerText = nextD;
                            let day = td.innerText;
                            td.onclick = function () {
                                addDateInput.value = `${year}-${month + 1}-${day}`;
                                // 呼叫 bootstrap Modal
                                bootstrap.Modal.getOrCreateInstance(addModal).show();
                            }
                            tr.appendChild(td);
                            nextD++;
                        }

                    }


                }
                tbody.append(tr);
            }


        }



        // 新增行程
        function addTodoItem() {
            let dateOfKey = addDateInput.value;
            let todoItem = addValueInput.value;

            let todoList = [];

            let todoObj = {
                date: dateOfKey,
                title: todoItem

            }


            if (localStorage.getItem(dateOfKey) == null) {
                todoList.push(todoObj);
            } else {
                // 取得 localstorage 的 陣列資料
                todoList = JSON.parse(localStorage.getItem(dateOfKey));
                // 把本次新增的資料 push 進陣列資料中
                todoList.push(todoObj);

            }

            localStorage.setItem(dateOfKey, JSON.stringify(todoList));
            bootstrap.Modal.getOrCreateInstance(addModal).hide();

            addDateInput.value = "";
            addValueInput.value = "";
            randerData();

            // let todoList = [
            //     {
            //         title : todoItem,
            //         startTime : '',
            //         endTime : '',
            //         color: 'red'
            //     }
            // ]

        }

        // 修改行程
        function editTodoItem() {

            let dateOfKey = editDateInput.value;
            let todoItem = editValueInput.value;

            let todoList = [];

            let todoObj = {
                date: dateOfKey,
                title: todoItem

            }

            // 取得 localstorage 的 陣列資料
            todoList = JSON.parse(localStorage.getItem(dateOfKey));
            let editIndex = editValueInput.getAttribute("data-num");
            todoList[editIndex] = todoObj;
            console.log(todoList);
            localStorage.setItem(dateOfKey,JSON.stringify(todoList));
            bootstrap.Modal.getOrCreateInstance(editModal).hide();

            addDateInput.value = "";
            addValueInput.value = "";
            randerData();

        }


        // 刪除行程
        function delTodoItem() {
            let dateOfKey = editDateInput.value;
            let todoList = [];
            // 取得 localstorage 的 陣列資料
            todoList = JSON.parse(localStorage.getItem(dateOfKey));
            let delIndex = editValueInput.getAttribute("data-num");
            todoList.splice(delIndex,1);
          
            console.log(todoList);
            localStorage.setItem(dateOfKey,JSON.stringify(todoList));
            bootstrap.Modal.getOrCreateInstance(editModal).hide();

            addDateInput.value = "";
            addValueInput.value = "";
            randerData();

        }



    </script>
    <!-- 載入Bootstrap 5.0 Bundle-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- 載入Font Awesome :Dora的帳號-->
    <script src="https://kit.fontawesome.com/0015b7851a.js" crossorigin="anonymous"></script>



</body>

</html>